<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard Test</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat-card { padding: 15px; border: 1px solid #ddd; border-radius: 8px; min-width: 120px; }
        .stat-number { font-size: 24px; font-weight: bold; color: #1565c0; }
        #map { height: 400px; width: 100%; border: 1px solid #ddd; border-radius: 8px; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f5f5f5; }
        .status-pending { background: #ff9800; color: white; padding: 4px 8px; border-radius: 4px; }
        .status-progress { background: #2196f3; color: white; padding: 4px 8px; border-radius: 4px; }
        .status-resolved { background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Admin Dashboard Test</h1>
    
    <div class="debug" id="debugInfo">Loading...</div>
    
    <div class="stats">
        <div class="stat-card">
            <div>Total Reports</div>
            <div class="stat-number" id="totalReportsCount">0</div>
        </div>
        <div class="stat-card">
            <div>Pending</div>
            <div class="stat-number" id="pendingCount">0</div>
        </div>
        <div class="stat-card">
            <div>In Progress</div>
            <div class="stat-number" id="inProgressCount">0</div>
        </div>
        <div class="stat-card">
            <div>Resolved</div>
            <div class="stat-number" id="resolvedCount">0</div>
        </div>
    </div>
    
    <h2>Map with Report Pins</h2>
    <div id="map"></div>
    
    <h2>Reports Table</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Status</th>
                <th>User</th>
                <th>Area</th>
                <th>Barangay</th>
                <th>Coordinates</th>
            </tr>
        </thead>
        <tbody id="reportsTableBody">
            <tr><td colspan="7">Loading...</td></tr>
        </tbody>
    </table>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([11.5411, 124.5405], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        let markers = [];
        
        // Test data (same structure as API)
        const testData = [
            {
                id: 1,
                title: 'Water Supply Interruption in Brgy. Centro',
                status: 'Pending',
                user: 'testuser',
                area: 'Water Supply',
                barangay: 'Centro',
                latitude: 11.5411,
                longitude: 124.5405,
                created_at: '2024-01-01 10:00:00'
            },
            {
                id: 2,
                title: 'Broken Water Pipe on Main Street',
                status: 'In Progress',
                user: 'testuser',
                area: 'Infrastructure',
                barangay: 'Poblacion',
                latitude: 11.55,
                longitude: 124.53,
                created_at: '2024-01-02 11:00:00'
            },
            {
                id: 3,
                title: 'Contaminated Water Source',
                status: 'Resolved',
                user: 'testuser',
                area: 'Water Quality',
                barangay: 'Libuton',
                latitude: 11.56,
                longitude: 124.52,
                created_at: '2024-01-03 12:00:00'
            }
        ];
        
        function updateDebugInfo(message) {
            document.getElementById('debugInfo').textContent = message;
        }
        
        function updateStats(data) {
            const total = data.length;
            const pending = data.filter(c => c.status.trim().toLowerCase() === 'pending').length;
            const inProgress = data.filter(c => c.status.trim().toLowerCase() === 'in progress').length;
            const resolved = data.filter(c => c.status.trim().toLowerCase() === 'resolved').length;
            
            document.getElementById('totalReportsCount').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('resolvedCount').textContent = resolved;
            
            updateDebugInfo(`Stats updated: Total=${total}, Pending=${pending}, InProgress=${inProgress}, Resolved=${resolved}`);
        }
        
        function updateTable(data) {
            const tbody = document.getElementById('reportsTableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No reports found</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(c => {
                let statusClass = 'status-pending';
                if (c.status.toLowerCase().includes('progress')) statusClass = 'status-progress';
                if (c.status.toLowerCase() === 'resolved') statusClass = 'status-resolved';
                
                return `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.title}</td>
                        <td><span class="${statusClass}">${c.status}</span></td>
                        <td>${c.user}</td>
                        <td>${c.area || 'N/A'}</td>
                        <td>${c.barangay || 'N/A'}</td>
                        <td>${c.latitude ? c.latitude.toFixed(4) : 'N/A'}, ${c.longitude ? c.longitude.toFixed(4) : 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateMap(data) {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            let validMarkers = 0;
            
            data.forEach(c => {
                if (c.latitude && c.longitude && !isNaN(c.latitude) && !isNaN(c.longitude)) {
                    const lat = parseFloat(c.latitude);
                    const lng = parseFloat(c.longitude);
                    
                    // Determine pin color based on status
                    let color;
                    const status = c.status.trim().toLowerCase();
                    
                    if (status === 'pending') {
                        color = '#ff9800'; // Orange
                    } else if (status.includes('progress')) {
                        color = '#2196f3'; // Blue
                    } else if (status === 'resolved') {
                        color = '#4caf50'; // Green
                    } else {
                        color = '#9e9e9e'; // Gray
                    }
                    
                    // Create marker
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            html: `
                                <div style="
                                    width: 20px;
                                    height: 20px;
                                    background-color: ${color};
                                    border: 2px solid white;
                                    border-radius: 50%;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                "></div>
                            `,
                            className: 'custom-marker',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <div style="min-width:200px;">
                            <h4 style="margin:0 0 10px; color:#1565c0;">${c.title}</h4>
                            <p><strong>Status:</strong> <span style="color:${color}; font-weight:bold;">${c.status}</span></p>
                            <p><strong>User:</strong> ${c.user}</p>
                            <p><strong>Area:</strong> ${c.area || 'N/A'}</p>
                            <p><strong>Barangay:</strong> ${c.barangay || 'N/A'}</p>
                            <p><strong>Coordinates:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}</p>
                        </div>
                    `);
                    
                    markers.push(marker);
                    validMarkers++;
                }
            });
            
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
            
            updateDebugInfo(`Map updated: ${validMarkers} markers created from ${data.length} reports`);
        }
        
        async function loadRealData() {
            try {
                updateDebugInfo('Attempting to load real data from API...');
                const response = await fetch('/api/all-complaints/');
                
                if (response.ok) {
                    const data = await response.json();
                    updateDebugInfo(`Successfully loaded ${data.length} reports from API`);
                    
                    updateStats(data);
                    updateTable(data);
                    updateMap(data);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateDebugInfo(`API failed (${error.message}), using test data`);
                
                // Use test data
                updateStats(testData);
                updateTable(testData);
                updateMap(testData);
            }
        }
        
        // Initialize with test data first
        updateDebugInfo('Initializing with test data...');
        updateStats(testData);
        updateTable(testData);
        updateMap(testData);
        
        // Try to load real data after 1 second
        setTimeout(loadRealData, 1000);
    </script>
</body>
</html>